<div id="search-overlay" class="search-overlay" aria-hidden="true">
  <div class="search-overlay-backdrop"></div>
  <div class="search-overlay-content">
      <div class="search-overlay-header">
        <span class="search-overlay-title">Search articles...</span>
        <button type="button" class="search-overlay-close" aria-label="Close">×</button>
      </div>
      <input type="search" id="search-input" class="search-input" placeholder="Type to search articles..." autocomplete="off">
      <div id="search-results" class="search-results"></div>
      <p class="search-overlay-hint">/ to search ESC to close ↑↓ to navigate Enter to select</p>
  </div>
</div>

<script>
(function() {
  var data = [
    {% for post in site.posts %}
    {"t":{{ post.title | jsonify }},"u":{{ post.url | relative_url | jsonify }},"e":{{ post.excerpt | default: "" | strip_html | truncate: 120 | jsonify }}}{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];

  var overlay = document.getElementById('search-overlay');
  var input = document.getElementById('search-input');
  var results = document.getElementById('search-results');
  var selectedIdx = -1;

  function openSearch() {
    overlay.setAttribute('aria-hidden', 'false');
    overlay.classList.add('search-overlay-open');
    input.value = '';
    input.focus();
    selectedIdx = -1;
    performSearch('');
  }

  function closeSearch() {
    overlay.setAttribute('aria-hidden', 'true');
    overlay.classList.remove('search-overlay-open');
  }

  function performSearch(q) {
    q = (q || '').toLowerCase().trim();
    results.innerHTML = '';
    selectedIdx = -1;
    if (!q) return;
    var matches = data.filter(function(p) {
      var t = (p.t || '').toLowerCase();
      var e = (p.e || '').toLowerCase();
      return t.indexOf(q) >= 0 || e.indexOf(q) >= 0;
    });
    matches.slice(0, 8).forEach(function(p) {
      var a = document.createElement('a');
      a.href = p.u;
      a.className = 'search-result-item';
      a.innerHTML = '<strong>' + p.t + '</strong><span>' + p.e + '</span>';
      results.appendChild(a);
    });
    updateSelection();
  }

  function updateSelection() {
    var items = results.querySelectorAll('.search-result-item');
    items.forEach(function(el, i) { el.classList.toggle('selected', i === selectedIdx); });
  }

  var searchBtn = document.querySelector('.search-toggle');
  if (searchBtn) searchBtn.addEventListener('click', openSearch);
  overlay.querySelector('.search-overlay-close')?.addEventListener('click', closeSearch);
  document.addEventListener('keydown', function(e) {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); openSearch(); }
    if (e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey && document.activeElement?.tagName !== 'INPUT' && document.activeElement?.tagName !== 'TEXTAREA') {
      e.preventDefault();
      openSearch();
    }
  });
  overlay.querySelector('.search-overlay-backdrop')?.addEventListener('click', closeSearch);
  input.addEventListener('input', function() { performSearch(this.value); });
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') { e.preventDefault(); closeSearch(); return; }
    var items = results.querySelectorAll('.search-result-item');
    if (e.key === 'ArrowDown' && items.length) {
      e.preventDefault();
      selectedIdx = Math.min(selectedIdx + 1, items.length - 1);
      updateSelection();
      items[selectedIdx]?.scrollIntoView({ block: 'nearest' });
      return;
    }
    if (e.key === 'ArrowUp' && items.length) {
      e.preventDefault();
      selectedIdx = Math.max(selectedIdx - 1, 0);
      updateSelection();
      items[selectedIdx]?.scrollIntoView({ block: 'nearest' });
      return;
    }
    if (e.key === 'Enter' && selectedIdx >= 0 && items[selectedIdx]) {
      e.preventDefault();
      window.location.href = items[selectedIdx].href;
    }
  });
})();
</script>
